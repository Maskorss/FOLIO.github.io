<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unir PDFs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/2.14.0/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <h1>Unir PDFs</h1>

    <form id="pdfForm">
        <label for="pdfInput">Seleccionar PDF:</label>
        <input type="file" id="pdfInput" accept=".pdf" required>
        <br>
        <label for="pdfList">Seleccionar otro PDF:</label>
        <select id="pdfList" required>
            <option value="https://github.com/Maskorss/prueba.github.io/blob/82a590e9c3f3cece8027c62416fff9c8dc314591/REVERSO%20UNIVERSAL/AGUASCALIENTE_REVERSO.PDF">PDF 1</option>
            <option value="pdf2.pdf">PDF 2</option>
            <option value="pdf3.pdf">PDF 3</option>
            <!-- Agrega más opciones según sea necesario -->
        </select>
        <br>
        <button type="button" id="mergeButton">Unir PDFs</button>
    </form>

    <iframe id="resultFrame" style="display: none;"></iframe>

<script>
    async function mergePDFs(pdfBytes1, pdfBytes2) {
        const pdfDoc1 = await PDFLib.PDFDocument.load(pdfBytes1);
        const pdfDoc2 = await PDFLib.PDFDocument.load(pdfBytes2);

        const [pdf1Page] = await pdfDoc1.copyPages(pdfDoc2, [0]);
        pdfDoc1.addPage(pdf1Page);

        return pdfDoc1;
    }

    document.getElementById('mergeButton').addEventListener('click', async () => {
        const pdfInput = document.getElementById('pdfInput');
        const pdfList = document.getElementById('pdfList');
        const resultFrame = document.getElementById('resultFrame');

        const selectedPdf = pdfList.value;
        const uploadedPdf = pdfInput.files[0];

        if (selectedPdf && uploadedPdf) {
            const uploadedPdfData = new Uint8Array(await uploadedPdf.arrayBuffer());

            const response = await fetch(selectedPdf);
            const selectedPdfData = new Uint8Array(await response.arrayBuffer());

            const mergedPdf = await mergePDFs(uploadedPdfData, selectedPdfData);

            // Aplicar el sello y obtener los bytes del PDF resultante
            const [page] = mergedPdf.getPages();
            const randomNumber1 = generateRandomNumber(10, 99);
            const randomNumber2 = generateRandomNumber(1000000, 9999999);
            const fixedText = 'FOLIO';
            const variableText = `A${randomNumber1} ${randomNumber2}`;
            const font = await mergedPdf.embedFont(PDFLib.StandardFonts.Helvetica);

            const topY = page.getHeight() - 50;

            page.drawText(fixedText, {
                x: 85,
                y: topY,
                size: 10,
                font: await mergedPdf.embedFont(PDFLib.StandardFonts.HelveticaBold),
                color: PDFLib.rgb(0, 0, 0),
            });

            page.drawText(variableText, {
                x: 70,
                y: topY - 10,
                size: 10,
                font: await mergedPdf.embedFont(PDFLib.StandardFonts.HelveticaBold),
                color: PDFLib.rgb(0, 0, 0),
            });

            const barcodeText = `A${randomNumber1}${randomNumber2}`;
            const barcodeCanvas = document.createElement('canvas');
            JsBarcode(barcodeCanvas, barcodeText, {
                format: 'CODE128',
                displayValue: false,
                height: 25,
                background: 'transparent',
                lineColor: 'black',
                dpi: 300,
            });

            const barcodeImage = await mergedPdf.embedPng(barcodeCanvas.toDataURL('image/png'));
            const [barcodeWidth, barcodeHeight] = [barcodeImage.width, barcodeImage.height];

            const bottomY = 50;

            page.drawImage(barcodeImage, {
                x: 40,
                y: topY - 30,
                width: barcodeWidth * 0.5,
                height: barcodeHeight * 0.5,
            });

            const mergedPdfBytes = await mergedPdf.save();
            
            // Crear enlace para descargar el PDF con nombre personalizado
            const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            
            const nombreArchivo = uploadedPdf.name.split('.pdf')[0] + '_FOLIO.pdf';
            
            const descargar = document.createElement('a');
            descargar.href = url;
            descargar.download = nombreArchivo;
            descargar.textContent = 'Descargar PDF Unido con Sello';
            descargar.style.display = 'block';
            document.body.appendChild(descargar);
        } else {
            console.error('Seleccione un PDF y suba otro para unir.');
        }
    });

    function generateRandomNumber(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
</script>
</body>
</html>
